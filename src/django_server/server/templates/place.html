{% extends "layout.html" %}
{% block header %}
<div id="header">
<div class="wrap">
<div id="search-container">
  <div id="logo" style="float:left;">
    <h3>G Explore</h3>
  </div>
  <input id="search-input" type="text" value="{{place}}" />
</div>
</div>
</div>
{% endblock %} 
{% block content %} 
<div id="results"></div>
<div id="map-canvas" style="display:none;"></div>
<script type="text/javascript">
  var map = new google.maps.Map(document.getElementById('map-canvas'));
  var place_service = new google.maps.places.PlacesService(map);
  load_search(document.getElementById("search-input"));
  function load_page(place) {
    $("#map-canvas").hide();
    $("#results").html('');
    if ("{{type}}" == "-1") {
      load_tourist_attractions_freebase(place)
      load_hotels_maps(place);
      load_restaurants_maps(place);
      load_bars_maps(place);
    } else {
      load_tourist_attractions_freebase(place)
      load_tourist_destinations_freebase(place)
    }
  }

  function load_hotels_maps(place) {
    var request = {
      query: "hotels near " + place,
    };
    
    place_service.textSearch(request, function(results){
      append_to_page(results, 'Hotels')
    });
  }

  function load_restaurants_maps(place) {
    var request = {
      query: "restaurants near " + place
    };
    
    place_service.textSearch(request, function(results){
      append_to_page(results, 'Restaurants')
    });
  }

  function load_bars_maps(place) {
    var request = {
      query: "bars near " + place
    };
    
    place_service.textSearch(request, function(results){
      append_to_page(results, 'Bars')
    });
  }

  function load_tourist_attractions_maps(place) {
    var request = {
      query: "tourist attractions near " + place
    };
    
    place_service.textSearch(request, function(results){
      var final_results = []
      for (var i=0; i<results.length; i++) {
        var match = results[i].name.match(/tour|travel|attractions|hotel|trip|pvt ltd/i);
        if (match) {
          continue
        }
        final_results.push(results[i])
      }
      append_to_page(final_results, 'Tourist Attractions')
    });
  }

  function load_tourist_destinations_freebase(place) {
    var terms = place.split(",");
    var fetch_params = {
      'limit': 35,
      'prefixed': true,
      'filter': '(all type:/travel/travel_destination part_of:"' + terms[0] + '")',
      'scoring': 'entity',
      'output': '(notable:/client/summary description type)'
    };
    fetch_freebase_suggestions({
      'fetch_params': fetch_params,
      'success': function(data) {
        var final_results = []
        for (var i=0; i<data.result.length; i++) {
          var match = data.result[i].name.match(terms[0]);
          if (match) {
            continue
          }
          final_results.push(data.result[i])
        }
        append_to_page_freebase(final_results, 'Top Destinations');
      }
    });
  }

  function load_tourist_attractions_freebase(place) {
    var terms = place.split(",")
    var limit = 35;
    if (terms.length > 2) {
      limit = 20;
    }
    var fetch_params = {
      'limit': limit,
      'prefixed': true,
      'filter': '(all type:/travel/tourist_attraction part_of:"' + terms[0] + '")',
      'scoring': 'entity',
      'output': '(notable:/client/summary description type)'
    };
    fetch_freebase_suggestions({
      'fetch_params': fetch_params,
      'success': function(data) {
        append_to_page_freebase(data.result, 'Top Attractions');
      }
    });
  }

  function load_hotels_freebase(place) {
    var terms = place.split(",")
    var fetch_params = {
      'prefixed': true,
      'filter': '(all type:/travel/hotel part_of:"' + terms[0] + '")',
      'scoring': 'entity',
      'output': '(notable:/client/summary description type)'
    };
    fetch_freebase_suggestions({
      'fetch_params': fetch_params,
      'success': function(data) {
        if (data.hits < 7) {
          load_hotels_maps(place)
          return
        }
        append_to_page_freebase(data.result, 'Top Hotels');
      }
    });
  }

  function append_to_page(results, title) {
    if (results.length < 1) return
    var html = '<h3>' + title + '</h3>';
    html += '<div class="results-list-container">';
    for (var i = 0; i < results.length; i++) {
      if (results[i].photos != null  && results[i].photos.length > 0) {
        var image_url = results[i].photos[0].getUrl({maxHeight:400});
        if (image_url == null) {
          image_url = FREEBASE_URL + '/freebase/no_image_png'
        }
        html += '<div class="result-item-container">';
        html += '<img class="result-item-image" src="' + image_url + '" />';
        html += '<div class="result-item-label">' + results[i].name + '</div>'
        html += '</div>';
      }
    }
    html += '</div>';
    $("#results").append(html);
  }

  function append_to_page_freebase(results, title) {
    if (results.length < 2) return
    var html = '<h3>' + title + '</h3>';
    html += '<div class="results-list-container">';
    for (var i = 0; i < results.length; i++) {
      if (results[i].notable.id == '/location/country') continue
      var image_url = FREEBASE_URL + '/image' +  results[i].mid + '?maxheight=300&errorid=/freebase/no_image_png';
      html += '<div class="result-item-container">';
      html += '<img class="result-item-image" src="' + image_url + '" />';
      html += '<div class="result-item-label">' + results[i].name + '</div>'        
      html += '</div>';      
    }
    html += '</div>';
    $("#results").append(html);
  }

  load_page("{{place}}");
</script>      

{% endblock %} 